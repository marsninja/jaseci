name: Documentation Validation

on:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/validate_docs_code.py'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/validate_docs_code.py'
      - '.github/workflows/docs-validation.yml'
  workflow_dispatch:

jobs:
  validate-syntax:
    name: Validate Code Block Syntax
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-jac-${{ hashFiles('jac/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-jac-

      - name: Install jaclang
        run: |
          python -m pip install --upgrade pip
          pip install -e jac

      - name: Validate Jac code block syntax
        run: python docs/scripts/validate_docs_code.py --docs-dir docs/docs

  check-internal-links:
    name: Check Internal Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e jac
          pip install -e docs

      - name: Build documentation
        working-directory: docs
        run: mkdocs build --strict 2>&1 | tee build.log || true

      - name: Check for broken links in build log
        working-directory: docs
        run: |
          if grep -i "warning" build.log | grep -i "link"; then
            echo "## ⚠️ Documentation Link Warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -i "warning" build.log | grep -i "link" >> $GITHUB_STEP_SUMMARY
            # Don't fail the build, just warn
          else
            echo "## ✅ No Link Warnings" >> $GITHUB_STEP_SUMMARY
          fi
