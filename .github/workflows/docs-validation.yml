name: Validate Documentation Code Blocks

on:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/validate_docs_code.py'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.md'
      - 'docs/scripts/validate_docs_code.py'
      - '.github/workflows/docs-validation.yml'
  workflow_dispatch:

jobs:
  validate-jac-code-blocks:
    name: Validate Jac Code Blocks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: true

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-jac-${{ hashFiles('jac/pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-jac-

      - name: Install jaclang
        run: |
          python -m pip install --upgrade pip
          pip install -e jac

      - name: Run Jac code block validation
        run: |
          python docs/scripts/validate_docs_code.py --docs-dir docs/docs --summary
        continue-on-error: true
        id: validate

      - name: Run validation (detailed on failure)
        if: steps.validate.outcome == 'failure'
        run: |
          echo "## ❌ Jac Code Block Validation Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Some code blocks in the documentation failed validation." >> $GITHUB_STEP_SUMMARY
          echo "Run \`python docs/scripts/validate_docs_code.py\` locally for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          python docs/scripts/validate_docs_code.py --docs-dir docs/docs 2>&1 | head -200 >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Report success
        if: steps.validate.outcome == 'success'
        run: |
          echo "## ✅ Jac Code Block Validation Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All code blocks in the documentation passed validation." >> $GITHUB_STEP_SUMMARY

  check-internal-links:
    name: Check Internal Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e jac
          pip install -e docs

      - name: Build documentation
        working-directory: docs
        run: mkdocs build --strict 2>&1 | tee build.log || true

      - name: Check for broken links in build log
        working-directory: docs
        run: |
          if grep -i "warning" build.log | grep -i "link"; then
            echo "## ⚠️ Documentation Link Warnings" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            grep -i "warning" build.log | grep -i "link" >> $GITHUB_STEP_SUMMARY
            # Don't fail the build, just warn
          else
            echo "## ✅ No Link Warnings" >> $GITHUB_STEP_SUMMARY
          fi
